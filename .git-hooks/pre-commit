#!/bin/bash
# Pre-commit hook for BuildMyBot
# Prevents committing sensitive credentials and build artifacts
#
# Installation:
#   chmod +x .git-hooks/pre-commit
#   cp .git-hooks/pre-commit .git/hooks/pre-commit
#
# Or run: npm run install-hooks

set -e

RESET='\033[0m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'

echo -e "${BLUE}ğŸ” Running pre-commit security checks...${RESET}"

# Track if any errors occurred
ERRORS=0

# =============================================================================
# Check 1: Prevent committing .env file
# =============================================================================
if git diff --cached --name-only | grep -q "^\.env$"; then
  echo -e "${RED}âŒ ERROR: Attempting to commit .env file${RESET}"
  echo -e "${YELLOW}The .env file contains sensitive credentials and should never be committed.${RESET}"
  echo ""
  echo "To fix this:"
  echo "  git reset HEAD .env"
  echo ""
  ERRORS=$((ERRORS + 1))
fi

# =============================================================================
# Check 2: Prevent committing dist/ directory
# =============================================================================
if git diff --cached --name-only | grep -q "^dist/"; then
  echo -e "${RED}âŒ ERROR: Attempting to commit dist/ directory${RESET}"
  echo -e "${YELLOW}Build artifacts should not be committed to version control.${RESET}"
  echo ""
  echo "To fix this:"
  echo "  git reset HEAD dist/"
  echo ""
  ERRORS=$((ERRORS + 1))
fi

# =============================================================================
# Check 3: Prevent committing node_modules
# =============================================================================
if git diff --cached --name-only | grep -q "^node_modules/"; then
  echo -e "${RED}âŒ ERROR: Attempting to commit node_modules/ directory${RESET}"
  echo -e "${YELLOW}Dependencies should not be committed to version control.${RESET}"
  echo ""
  echo "To fix this:"
  echo "  git reset HEAD node_modules/"
  echo ""
  ERRORS=$((ERRORS + 1))
fi

# =============================================================================
# Check 4: Detect real Supabase credentials in .env.example
# =============================================================================
if git diff --cached .env.example 2>/dev/null | grep -qE "mnklzzundmfwjnfaoqju|eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ua2x6enVuZG1md2puZmFvcWp1Ii"; then
  echo -e "${RED}âŒ ERROR: Real Supabase credentials detected in .env.example${RESET}"
  echo -e "${YELLOW}Production credentials must not be in .env.example - use placeholders only.${RESET}"
  echo ""
  echo "Replace with:"
  echo "  VITE_SUPABASE_URL=https://your-project-ref.supabase.co"
  echo "  VITE_SUPABASE_ANON_KEY=your-supabase-anon-key-here"
  echo ""
  ERRORS=$((ERRORS + 1))
fi

# =============================================================================
# Check 5: Detect real Stripe live keys
# =============================================================================
if git diff --cached | grep -qE "sk_live_[0-9A-Za-z]{99,}"; then
  echo -e "${RED}âŒ ERROR: Stripe secret key (sk_live_) detected${RESET}"
  echo -e "${YELLOW}Never commit Stripe secret keys to version control.${RESET}"
  echo ""
  echo "If this is a placeholder in .env.example, use:"
  echo "  STRIPE_SECRET_KEY=sk_live_REPLACE_ME"
  echo ""
  ERRORS=$((ERRORS + 1))
fi

# =============================================================================
# Check 6: Detect Stripe publishable live keys (99+ chars)
# =============================================================================
if git diff --cached | grep -qE "pk_live_[0-9A-Za-z]{99,}"; then
  echo -e "${YELLOW}âš ï¸  WARNING: Stripe publishable key (pk_live_) detected${RESET}"
  echo -e "${YELLOW}While publishable keys can be public, ensure this is intentional.${RESET}"
  echo ""
  read -p "Continue commit? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${RED}Commit cancelled by user${RESET}"
    exit 1
  fi
fi

# =============================================================================
# Check 7: Detect OpenAI API keys
# =============================================================================
if git diff --cached | grep -qE "sk-proj-[a-zA-Z0-9]{48,}|sk-[a-zA-Z0-9]{48,}"; then
  echo -e "${RED}âŒ ERROR: OpenAI API key detected${RESET}"
  echo -e "${YELLOW}API keys should not be committed to version control.${RESET}"
  echo ""
  echo "If this is a placeholder in .env.example, use:"
  echo "  OPENAI_API_KEY=sk-proj_REPLACE_ME"
  echo ""
  ERRORS=$((ERRORS + 1))
fi

# =============================================================================
# Check 8: Detect JWT tokens (common in Supabase)
# =============================================================================
if git diff --cached | grep -qE "eyJ[a-zA-Z0-9_-]{20,}\\.eyJ[a-zA-Z0-9_-]{20,}"; then
  # Ignore if it's in a placeholder context
  if ! git diff --cached | grep -B2 -A2 "eyJ" | grep -q "your-.*-key-here\|REPLACE_ME\|your-supabase-anon-key"; then
    echo -e "${RED}âŒ ERROR: JWT token detected${RESET}"
    echo -e "${YELLOW}JWT tokens (like Supabase keys) should not be committed.${RESET}"
    echo ""
    ERRORS=$((ERRORS + 1))
  fi
fi

# =============================================================================
# Check 9: Detect AWS credentials
# =============================================================================
if git diff --cached | grep -qE "AKIA[0-9A-Z]{16}"; then
  echo -e "${RED}âŒ ERROR: AWS access key detected${RESET}"
  echo -e "${YELLOW}AWS credentials should never be committed to version control.${RESET}"
  echo ""
  ERRORS=$((ERRORS + 1))
fi

# =============================================================================
# Check 10: Detect private keys
# =============================================================================
if git diff --cached | grep -qE "BEGIN (RSA |DSA |EC )?PRIVATE KEY"; then
  echo -e "${RED}âŒ ERROR: Private key detected${RESET}"
  echo -e "${YELLOW}Private keys must never be committed to version control.${RESET}"
  echo ""
  ERRORS=$((ERRORS + 1))
fi

# =============================================================================
# Check 11: Warn about large files
# =============================================================================
LARGE_FILES=$(git diff --cached --name-only | while read file; do
  if [ -f "$file" ]; then
    size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
    if [ "$size" -gt 5242880 ]; then  # 5MB
      echo "$file ($((size / 1024 / 1024))MB)"
    fi
  fi
done)

if [ -n "$LARGE_FILES" ]; then
  echo -e "${YELLOW}âš ï¸  WARNING: Large files detected (>5MB):${RESET}"
  echo "$LARGE_FILES"
  echo ""
  echo "Consider:"
  echo "  - Using Git LFS for large files"
  echo "  - Adding to .gitignore if this is a build artifact"
  echo ""
  read -p "Continue commit? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${RED}Commit cancelled by user${RESET}"
    exit 1
  fi
fi

# =============================================================================
# Check 12: Verify .gitignore includes sensitive files
# =============================================================================
if [ -f .gitignore ]; then
  if ! grep -q "^\.env$" .gitignore; then
    echo -e "${YELLOW}âš ï¸  WARNING: .env not in .gitignore${RESET}"
    echo "Add this line to .gitignore:"
    echo "  .env"
    echo ""
  fi
  if ! grep -q "^dist" .gitignore; then
    echo -e "${YELLOW}âš ï¸  WARNING: dist/ not in .gitignore${RESET}"
    echo "Add this line to .gitignore:"
    echo "  dist"
    echo ""
  fi
fi

# =============================================================================
# Final result
# =============================================================================
if [ $ERRORS -gt 0 ]; then
  echo ""
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
  echo -e "${RED}âŒ Pre-commit checks FAILED with ${ERRORS} error(s)${RESET}"
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
  echo ""
  echo "Commit blocked to protect sensitive information."
  echo "Fix the errors above and try again."
  echo ""
  echo "To bypass (NOT recommended):"
  echo "  git commit --no-verify"
  echo ""
  exit 1
else
  echo -e "${GREEN}âœ… Pre-commit checks passed${RESET}"
  echo ""
fi

exit 0
