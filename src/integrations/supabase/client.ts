// This file is automatically generated. Do not edit it directly.
import { createClient, type SupabaseClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { env } from '@/config/env';

const { supabaseUrl, supabaseAnonKey } = env;

// Debug: Log what we're getting from env (remove in production)
if (typeof window !== 'undefined') {
  console.log('[Supabase Client] URL:', supabaseUrl);
  console.log('[Supabase Client] Key present:', !!supabaseAnonKey);
  console.log('[Supabase Client] Key length:', supabaseAnonKey?.length || 0);
}

const DISABLED_SUPABASE_MESSAGE =
  'Supabase is not configured. Please set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY in your environment.';

// List of placeholder/invalid URL patterns that should be rejected
const PLACEHOLDER_PATTERNS = [
  'your-project-ref',
  'your-supabase',
  'example.com',
  'localhost',
  'REPLACE_ME',
  'XXXXXXXX',
];

// Validate that the Supabase URL is not a placeholder value
const isValidSupabaseUrl = (url: string): boolean => {
  if (!url || url.trim() === '') return false;

  // Check if URL contains any placeholder patterns
  const lowerUrl = url.toLowerCase();
  if (PLACEHOLDER_PATTERNS.some(pattern => lowerUrl.includes(pattern.toLowerCase()))) {
    return false;
  }

  // Validate URL format
  try {
    const urlObj = new URL(url);
    // Must be https and contain 'supabase' in the hostname
    return urlObj.protocol === 'https:' && urlObj.hostname.includes('supabase');
  } catch {
    return false;
  }
};

// Validate that the anon key is not a placeholder value
const isValidSupabaseKey = (key: string): boolean => {
  if (!key || key.trim() === '') return false;

  // Check if key contains placeholder patterns
  const lowerKey = key.toLowerCase();
  if (PLACEHOLDER_PATTERNS.some(pattern => lowerKey.includes(pattern.toLowerCase()))) {
    return false;
  }

  // Anon keys should be reasonably long (at least 100 characters for real Supabase keys)
  return key.length > 100;
};

const urlValid = supabaseUrl ? isValidSupabaseUrl(supabaseUrl) : false;
const keyValid = supabaseAnonKey ? isValidSupabaseKey(supabaseAnonKey) : false;

if (typeof window !== 'undefined') {
  console.log('[Supabase Client] URL valid:', urlValid);
  console.log('[Supabase Client] Key valid:', keyValid);
}

const isSupabaseConfigured = Boolean(
  supabaseUrl &&
  supabaseAnonKey &&
  urlValid &&
  keyValid
);

const createDisabledSupabaseClient = (): SupabaseClient<Database> =>
  new Proxy({}, {
    get(_target, property: string | symbol) {
      throw new Error(`${DISABLED_SUPABASE_MESSAGE} Attempted to access "${String(property)}" on the disabled client.`);
    },
  }) as unknown as SupabaseClient<Database>;

const createSupabaseBrowserClient = (): SupabaseClient<Database> => {
  if (!isSupabaseConfigured) {
    console.warn(DISABLED_SUPABASE_MESSAGE);
    console.warn('Supabase URL:', supabaseUrl || '(empty)');
    console.warn('Supabase Key length:', supabaseAnonKey?.length || 0);
    return createDisabledSupabaseClient();
  }

  try {
    return createClient<Database>(supabaseUrl, supabaseAnonKey, {
      auth: {
        storage: localStorage,
        persistSession: true,
        autoRefreshToken: true,
      },
    });
  } catch (error) {
    console.error('Failed to create Supabase client:', error);
    return createDisabledSupabaseClient();
  }
};

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createSupabaseBrowserClient();

export { isSupabaseConfigured };
