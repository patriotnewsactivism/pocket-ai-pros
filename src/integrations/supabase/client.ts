// This file is automatically generated. Do not edit it directly.
import { createClient, type SupabaseClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { env } from '@/config/env';

const { supabaseUrl, supabaseAnonKey } = env;

const DISABLED_SUPABASE_MESSAGE =
  'Supabase is not configured. Please set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY in your environment.';

// List of placeholder/invalid URL patterns that should be rejected
const PLACEHOLDER_PATTERNS = [
  'your-project-ref',
  'your-supabase',
  'example.com',
  'localhost',
  'REPLACE_ME',
  'XXXXXXXX',
];

// Validate that the Supabase URL is not a placeholder value
const isValidSupabaseUrl = (url: string): boolean => {
  if (!url || url.trim() === '') return false;

  // Check if URL contains any placeholder patterns
  const lowerUrl = url.toLowerCase();
  if (PLACEHOLDER_PATTERNS.some(pattern => lowerUrl.includes(pattern.toLowerCase()))) {
    return false;
  }

  // Validate URL format
  try {
    const urlObj = new URL(url);
    // Must be https and contain 'supabase' in the hostname
    if (urlObj.protocol !== 'https:' || !urlObj.hostname.includes('supabase')) {
      return false;
    }

    // Additional check: hostname should match pattern *.supabase.co or *.supabase.com
    const hostnamePattern = /^[a-z0-9-]+\.supabase\.(co|com)$/i;
    if (!hostnamePattern.test(urlObj.hostname)) {
      return false;
    }

    return true;
  } catch {
    return false;
  }
};

// Validate that the anon key is not a placeholder value
const isValidSupabaseKey = (key: string): boolean => {
  if (!key || key.trim() === '') return false;

  // Check if key contains placeholder patterns
  const lowerKey = key.toLowerCase();
  if (PLACEHOLDER_PATTERNS.some(pattern => lowerKey.includes(pattern.toLowerCase()))) {
    return false;
  }

  // Anon keys should be reasonably long (at least 100 characters for real Supabase keys)
  if (key.length < 100) {
    return false;
  }

  // Supabase anon keys are JWT tokens, so they should start with 'eyJ' (base64 for '{"')
  // and contain two dots (header.payload.signature)
  const jwtPattern = /^eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$/;
  if (!jwtPattern.test(key)) {
    return false;
  }

  return true;
};

const urlValid = supabaseUrl ? isValidSupabaseUrl(supabaseUrl) : false;
const keyValid = supabaseAnonKey ? isValidSupabaseKey(supabaseAnonKey) : false;

// Log validation results
if (typeof window !== 'undefined') {
  console.log('[Supabase Client] URL:', supabaseUrl ? supabaseUrl.substring(0, 50) + '...' : '(empty)');
  console.log('[Supabase Client] URL valid:', urlValid);
  console.log('[Supabase Client] Key present:', !!supabaseAnonKey);
  console.log('[Supabase Client] Key length:', supabaseAnonKey?.length || 0);
  console.log('[Supabase Client] Key valid:', keyValid);
}

const isSupabaseConfigured = Boolean(
  supabaseUrl &&
  supabaseAnonKey &&
  urlValid &&
  keyValid
);

// Log final configuration status
if (typeof window !== 'undefined') {
  console.log('[Supabase Client] Configuration valid:', isSupabaseConfigured);
  if (!isSupabaseConfigured) {
    console.warn('[Supabase Client] ⚠️ Supabase client is DISABLED - authentication will not work');
  }
}

const createDisabledSupabaseClient = (): SupabaseClient<Database> =>
  new Proxy({}, {
    get(_target, property: string | symbol) {
      throw new Error(`${DISABLED_SUPABASE_MESSAGE} Attempted to access "${String(property)}" on the disabled client.`);
    },
  }) as unknown as SupabaseClient<Database>;

const createSupabaseBrowserClient = (): SupabaseClient<Database> => {
  // First check: Don't even try to create client if config is invalid
  if (!isSupabaseConfigured) {
    console.warn(DISABLED_SUPABASE_MESSAGE);
    return createDisabledSupabaseClient();
  }

  // Second check: Try to create client, but catch any errors
  try {
    console.log('[Supabase Client] Creating real Supabase client...');
    const client = createClient<Database>(supabaseUrl, supabaseAnonKey, {
      auth: {
        storage: localStorage,
        persistSession: true,
        autoRefreshToken: true,
      },
    });
    console.log('[Supabase Client] ✓ Real Supabase client created successfully');
    return client;
  } catch (error) {
    console.error('[Supabase Client] ✗ Failed to create Supabase client:', error);
    console.error('[Supabase Client] Falling back to disabled client');
    return createDisabledSupabaseClient();
  }
};

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createSupabaseBrowserClient();

export { isSupabaseConfigured };
