// This file is automatically generated. Do not edit it directly.
import { createClient, type SupabaseClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { env } from '@/config/env';

const { supabaseUrl, supabaseAnonKey } = env;

const DISABLED_SUPABASE_MESSAGE =
  'Supabase is not configured. Please set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY in your environment.';

// List of placeholder/invalid URL patterns that should be rejected
const PLACEHOLDER_PATTERNS = [
  'your-project-ref',
  'your-supabase',
  'example.com',
  'localhost',
  'REPLACE_ME',
  'XXXXXXXX',
];

// Validate that the Supabase URL is not a placeholder value
const isValidSupabaseUrl = (url: string): boolean => {
  if (!url || url.trim() === '') return false;

  // Check if URL contains any placeholder patterns
  const lowerUrl = url.toLowerCase();
  if (PLACEHOLDER_PATTERNS.some(pattern => lowerUrl.includes(pattern.toLowerCase()))) {
    return false;
  }

  // Validate URL format
  try {
    const urlObj = new URL(url);
    // Must be https and contain 'supabase' in the hostname
    return urlObj.protocol === 'https:' && urlObj.hostname.includes('supabase');
  } catch {
    return false;
  }
};

// Validate that the anon key is not a placeholder value
const isValidSupabaseKey = (key: string): boolean => {
  if (!key || key.trim() === '') return false;

  // Check if key contains placeholder patterns
  const lowerKey = key.toLowerCase();
  if (PLACEHOLDER_PATTERNS.some(pattern => lowerKey.includes(pattern.toLowerCase()))) {
    return false;
  }

  // Anon keys should be reasonably long (at least 100 characters for real Supabase keys)
  return key.length > 100;
};

const isSupabaseConfigured = Boolean(
  supabaseUrl &&
  supabaseAnonKey &&
  isValidSupabaseUrl(supabaseUrl) &&
  isValidSupabaseKey(supabaseAnonKey)
);

const createDisabledSupabaseClient = (): SupabaseClient<Database> =>
  new Proxy({}, {
    get(_target, property: string | symbol) {
      throw new Error(`${DISABLED_SUPABASE_MESSAGE} Attempted to access "${String(property)}" on the disabled client.`);
    },
  }) as unknown as SupabaseClient<Database>;

const createSupabaseBrowserClient = (): SupabaseClient<Database> => {
  if (!isSupabaseConfigured) {
    console.warn(DISABLED_SUPABASE_MESSAGE);
    return createDisabledSupabaseClient();
  }

  return createClient<Database>(supabaseUrl, supabaseAnonKey, {
    auth: {
      storage: localStorage,
      persistSession: true,
      autoRefreshToken: true,
    },
  });
};

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createSupabaseBrowserClient();

export { isSupabaseConfigured };
